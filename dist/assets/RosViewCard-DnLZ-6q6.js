import{_ as ce,M as $e,i as c,x as L,k as de,z as ve,e as ee,o as z,b as A,a as W,c as E,w as l,d as a,p as I,r,g as d,t as F,q as O,n as Z,N as We,h as De}from"./index-BOH9GfG6.js";import{R as ue}from"./RosLib-C7gnwWt6.js";const Oe={class:"ros-video-viewer"},je={__name:"RosViewer",props:{wsUrl:{type:String,required:!0},topicName:{type:String,required:!0},startVideo:{type:Boolean,default:!1}},emits:["connection-change","connection-error","viewing-change","topic-error","status-update"],setup(k,{emit:G}){const s=k,v=G,i=$e("videoCanvas"),C=c("initializing"),N=c(!1);let u=null,U=null;const w=n=>{v("status-update",n)},B=()=>{const n=i.value;if(!n)return;const y=n.getContext("2d");y.fillStyle="#888",y.fillRect(0,0,n.width,n.height),y.fillStyle="#fff",y.font="20px Arial",y.textAlign="center",y.fillText("等待视频画面...",n.width/2,n.height/2)},D=()=>{if(!s.wsUrl){w("WebSocket URL 不能为空"),C.value="error",v("connection-error",{type:"invalid_url",message:"WebSocket URL 不能为空"});return}u=new ue.Ros({url:s.wsUrl}),u.on("connection",()=>{C.value="connected",s.startVideo&&f()}),u.on("error",n=>{w(`连接错误: ${n.toString()}`),C.value="error",v("connection-error",{type:"connection_error",message:n.toString()})}),u.on("close",()=>{C.value="closed",g()})},f=()=>{if(!u||C.value!=="connected"){w("无法启动视频流: 未连接到ROS"),v("viewing-change",!1);return}if(!s.topicName){w("无法启动视频流: Topic名称不能为空"),v("topic-error",{type:"empty_topic",message:"Topic名称不能为空"});return}const n=s.topicName.includes("compressed"),y=n?"sensor_msgs/CompressedImage":"sensor_msgs/Image";U=new ue.Topic({ros:u,name:s.topicName,messageType:y}),U.subscribe(q=>{const x=i.value;if(!x)return;const _=x.getContext("2d");if(n){const p=new Image;p.onload=()=>{x.width=p.width,x.height=p.height,_.drawImage(p,0,0)},p.src="data:image/jpeg;base64,"+q.data}else{const{width:p,height:m,data:R}=q,T=_.createImageData(p,m),V=T.data;for(let h=0;h<R.length;h+=4)V[h+3]=R[h].charCodeAt(),V[h+2]=R[h+1].charCodeAt(),V[h+1]=R[h+2].charCodeAt(),V[h]=R[h+3].charCodeAt();x.width=p,x.height=m,_.putImageData(T,0,0)}N.value=!0,v("viewing-change",!0)})},g=()=>{U&&(U.unsubscribe(),U=null),N.value=!1,B()};return L(()=>s.wsUrl,n=>{n&&D()}),L(()=>s.topicName,n=>{N.value&&(g(),n&&C.value==="connected"&&f())}),L(()=>s.startVideo,n=>{n&&!N.value&&C.value==="connected"?f():!n&&N.value&&g()}),de(()=>{B(),s.wsUrl?D():w("请提供WebSocket URL")}),ve(()=>{g(),u&&(u.close(),u=null)}),(n,y)=>(z(),ee("div",Oe,[A("canvas",{ref_key:"videoCanvas",ref:i,class:"video-canvas transition-all duration-300"},null,512)]))}},Je=ce(je,[["__scopeId","data-v-22557d3b"]]),Ge={class:"title-text"},He={key:0,class:"video-overlay"},Ke={class:"mt-2 overlay-message"},Qe={key:0,class:"settings-panel"},Xe={class:"d-flex align-center"},Ye={class:"text-caption text-medium-emphasis status-text"},Ze={__name:"RosViewCard",props:{title:{type:String,default:"ROS视频查看器"},wsUrl:{type:String,default:""},topicName:{type:String,default:""},autoStart:{type:Boolean,default:!1},elevation:{type:[Number,String],default:2},variant:{type:String,default:"elevated"},defaultExpanded:{type:Boolean,default:!1},alwaysShowControls:{type:Boolean,default:!1},showSubtitle:{type:Boolean,default:!0},showMenu:{type:Boolean,default:!0},hideOverlay:{type:Boolean,default:!1},savedPresets:{type:Array,default:()=>[]}},emits:["update:wsUrl","update:topicName","update:autoStart","connection-change","connection-error","viewing-change","topic-error","status-update","preset-save","preset-load","fullscreen-change"],setup(k,{emit:G}){const s=k,v=G,i=c("initializing"),C=c(!1),N=c(""),u=c(!1),U=c(s.defaultExpanded),w=c(!1),B=c(null),D=c(null),f=c(s.wsUrl||""),g=c(s.topicName||""),n=c(s.autoStart),y=c("4:3"),q=c(null),x=c([{id:null,name:"选择预设"},...s.savedPresets]),_=c(s.wsUrl||""),p=c(s.topicName||""),m=c(s.autoStart),R=c(!1),T=c(""),V=c({show:!1,text:"",color:"info",timeout:3e3}),h=W(()=>f.value!==_.value||g.value!==p.value||n.value!==m.value),me=W(()=>!!f.value&&h.value),te=W(()=>{switch(i.value){case"initializing":return"正在连接...";case"connected":return"已连接";case"error":return"连接错误";case"closed":return"连接已关闭";default:return"未连接"}}),fe=W(()=>{switch(i.value){case"initializing":return"mdi-loading mdi-spin";case"connected":return"mdi-check-circle";case"error":return"mdi-alert-circle";case"closed":return"mdi-connection";default:return"mdi-help-circle"}}),pe=W(()=>{switch(i.value){case"initializing":return"info";case"connected":return"success";case"error":return"error";case"closed":return"grey";default:return"grey"}}),ge=W(()=>i.value==="initializing"?"正在连接...":i.value==="connected"&&m.value?"正在等待视频流...":i.value==="error"?N.value||"连接错误":i.value==="closed"?"连接已关闭":"视频未启动"),_e=t=>{i.value=t,v("connection-change",t)},be=t=>{v("connection-error",t),M(`连接错误: ${t.message}`,"error")},we=t=>{C.value=t,v("viewing-change",t)},ye=t=>{v("topic-error",t),M(`Topic错误: ${t.message}`,"error")},xe=t=>{N.value=t,v("status-update",t)},ae=async()=>{try{if(!(await D.value?.validate())?.valid)return}catch(t){console.warn("表单验证错误:",t)}u.value=!0,_.value=f.value,v("update:wsUrl",f.value),setTimeout(()=>{p.value=g.value,m.value=n.value,v("update:topicName",g.value),v("update:autoStart",n.value),u.value=!1},500)},Se=()=>{f.value=_.value||"",g.value=p.value||"",n.value=m.value},Ce=()=>{m.value=!m.value,v("update:autoStart",m.value)},le=()=>{i.value="initializing",m.value=!1,C.value=!1,setTimeout(()=>{const t=_.value;_.value="",setTimeout(()=>{_.value=t||f.value,n.value&&setTimeout(()=>{m.value=!0},1e3)},300)},300)},he=()=>{T.value="",R.value=!0},ke=()=>{if(!T.value)return;const t={id:Date.now().toString(),name:T.value,wsUrl:f.value,topicName:g.value,aspectRatio:y.value,autoConnect:n.value};Array.isArray(x.value)||(x.value=[]),x.value=[{id:null,name:"选择预设"},...x.value.filter(e=>e.id!==null),t],q.value=t.id,R.value=!1,v("preset-save",t),M("预设已保存","success")},Ue=t=>{if(!t)return;const e=x.value.find(b=>b.id===t);e&&(f.value=e.wsUrl||"",g.value=e.topicName||"",y.value=e.aspectRatio||"4:3",n.value=e.autoConnect,v("preset-load",e),M(`已加载预设: ${e.name}`,"info"))},ne=()=>{if(w.value=!w.value,v("fullscreen-change",w.value),w.value){const t=B.value;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}else document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},Ve=()=>{const t={wsUrl:_.value,topicName:p.value};navigator.clipboard.writeText(JSON.stringify(t,null,2)).then(()=>{M("连接信息已复制到剪贴板","success")}).catch(()=>{M("复制失败","error")})},M=(t,e="info",b=3e3)=>{V.value={show:!0,text:t,color:e,timeout:b}},Re=t=>t?t.startsWith("ws://")||t.startsWith("wss://")||"请输入有效的WebSocket URL (ws:// 或 wss://)":!0;L(()=>s.wsUrl,t=>{t!==f.value&&(f.value=t||""),t!==_.value&&(_.value=t||"")}),L(()=>s.topicName,t=>{t!==g.value&&(g.value=t||""),t!==p.value&&(p.value=t||"")}),L(()=>s.autoStart,t=>{t!==n.value&&(n.value=t),t!==m.value&&(m.value=t)}),L(()=>s.savedPresets,t=>{t&&Array.isArray(t)&&(x.value=[{id:null,name:"选择预设"},...t])}),L(y,t=>{const e=B.value;if(!e)return;const b=e.querySelector("canvas");b&&(t==="4:3"?b.style.aspectRatio="4/3":t==="16:9"?b.style.aspectRatio="16/9":b.style.aspectRatio="auto")});const P=()=>{w.value=!!document.fullscreenElement||!!document.webkitFullscreenElement||!!document.msFullscreenElement};return de(()=>{document.addEventListener("fullscreenchange",P),document.addEventListener("webkitfullscreenchange",P),document.addEventListener("MSFullscreenChange",P),f.value=s.wsUrl||"",g.value=s.topicName||"",_.value=s.wsUrl||"",p.value=s.topicName||"",n.value=s.autoStart,m.value=s.autoStart,_.value&&i.value!=="connected"&&(i.value="initializing",setTimeout(()=>{i.value==="initializing"&&(i.value="connected")},1e3))}),ve(()=>{document.removeEventListener("fullscreenchange",P),document.removeEventListener("webkitfullscreenchange",P),document.removeEventListener("MSFullscreenChange",P)}),(t,e)=>{const b=r("v-icon"),$=r("v-spacer"),S=r("v-btn"),H=r("v-list-item-title"),K=r("v-list-item"),ze=r("v-list"),Ne=r("v-menu"),oe=r("v-card-title"),Te=r("v-card-subtitle"),Ee=r("v-card-item"),Fe=r("v-progress-circular"),Q=r("v-divider"),X=r("v-text-field"),j=r("v-col"),se=r("v-row"),Le=r("v-select"),Ie=r("v-btn-toggle"),Ae=r("v-switch"),Be=r("v-form"),ie=r("v-card-text"),Y=r("v-card-actions"),qe=r("v-expand-transition"),J=r("v-tooltip"),re=r("v-card"),Me=r("v-dialog"),Pe=r("v-snackbar");return z(),E(re,{class:Z(["ros-video-card",{connecting:i.value==="initializing",error:i.value==="error","md3-card":!0}]),elevation:k.elevation,variant:k.variant},{default:l(()=>[a(Ee,null,{default:l(()=>[a(oe,{class:"d-flex align-center card-title"},{default:l(()=>[a(b,{class:"mr-2 status-icon",color:pe.value},{default:l(()=>[d(F(fe.value),1)]),_:1},8,["color"]),A("span",Ge,F(k.title),1),a($),k.showMenu?(z(),E(Ne,{key:0,transition:"scale-transition",location:"bottom end"},{activator:l(({props:o})=>[a(S,O({icon:"",variant:"text"},o,{density:"comfortable",class:"menu-btn"}),{default:l(()=>[a(b,null,{default:l(()=>e[11]||(e[11]=[d("mdi-dots-vertical")])),_:1})]),_:2},1040)]),default:l(()=>[a(ze,{class:"menu-list"},{default:l(()=>[a(K,{onClick:le,class:"menu-list-item"},{default:l(()=>[a(H,null,{default:l(()=>[a(b,{class:"mr-2",size:"small"},{default:l(()=>e[12]||(e[12]=[d("mdi-refresh")])),_:1}),e[13]||(e[13]=d(" 重新连接 "))]),_:1})]),_:1}),a(K,{onClick:Ve,class:"menu-list-item"},{default:l(()=>[a(H,null,{default:l(()=>[a(b,{class:"mr-2",size:"small"},{default:l(()=>e[14]||(e[14]=[d("mdi-content-copy")])),_:1}),e[15]||(e[15]=d(" 复制连接信息 "))]),_:1})]),_:1}),a(K,{onClick:ne,class:"menu-list-item"},{default:l(()=>[a(H,null,{default:l(()=>[a(b,{class:"mr-2",size:"small"},{default:l(()=>[d(F(w.value?"mdi-fullscreen-exit":"mdi-fullscreen"),1)]),_:1}),d(" "+F(w.value?"退出全屏":"全屏查看"),1)]),_:1})]),_:1})]),_:1})]),_:1})):I("",!0)]),_:1}),k.showSubtitle?(z(),E(Te,{key:0,class:"status-subtitle"},{default:l(()=>[A("span",{class:Z({"text-error":i.value==="error"})},F(N.value||te.value),3)]),_:1})):I("",!0)]),_:1}),A("div",{ref_key:"videoContainer",ref:B,class:Z(["video-container",{fullscreen:w.value}])},[a(Je,{"ws-url":_.value,"topic-name":p.value,"start-video":m.value,onConnectionChange:_e,onConnectionError:be,onViewingChange:we,onTopicError:ye,onStatusUpdate:xe},null,8,["ws-url","topic-name","start-video"]),a(We,{name:"fade"},{default:l(()=>[!C.value&&!k.hideOverlay?(z(),ee("div",He,[i.value==="initializing"||i.value==="connected"&&m.value?(z(),E(Fe,{key:0,indeterminate:"",color:"primary",size:"64",class:"progress-indicator"})):i.value==="error"?(z(),E(b,{key:1,size:"64",color:"error",class:"status-large-icon"},{default:l(()=>e[16]||(e[16]=[d("mdi-alert-circle")])),_:1})):i.value==="closed"?(z(),E(b,{key:2,size:"64",color:"grey",class:"status-large-icon"},{default:l(()=>e[17]||(e[17]=[d("mdi-video-off")])),_:1})):I("",!0),A("span",Ke,F(ge.value),1)])):I("",!0)]),_:1})],2),a(qe,null,{default:l(()=>[U.value||k.alwaysShowControls?(z(),ee("div",Qe,[a(Q),a(ie,null,{default:l(()=>[a(Be,{onSubmit:De(ae,["prevent"]),ref_key:"form",ref:D},{default:l(()=>[a(se,{dense:""},{default:l(()=>[a(j,{cols:"12",sm:"6"},{default:l(()=>[a(X,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value=o),label:"WebSocket URL",hint:"例如: ws://localhost:9090","persistent-hint":"",rules:[o=>!!o||"URL不能为空",Re],error:i.value==="error",disabled:u.value,variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-web",clearable:"",class:"md3-field"},null,8,["modelValue","rules","error","disabled"])]),_:1}),a(j,{cols:"12",sm:"6"},{default:l(()=>[a(X,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=o=>g.value=o),label:"Topic 名称",hint:"例如: /camera/image_raw/compressed","persistent-hint":"",rules:[o=>!!o||"Topic不能为空"],variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-camera",clearable:"",class:"md3-field"},null,8,["modelValue","rules"])]),_:1})]),_:1}),a(se,{dense:"",class:"mt-1"},{default:l(()=>[a(j,{cols:"12",sm:"6"},{default:l(()=>[a(Le,{modelValue:q.value,"onUpdate:modelValue":[e[2]||(e[2]=o=>q.value=o),Ue],label:"预设",items:x.value,"item-title":"name","item-value":"id",disabled:u.value,variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-bookmark-outline",class:"md3-field"},null,8,["modelValue","items","disabled"])]),_:1}),a(j,{cols:"12",sm:"6",class:"d-flex align-center"},{default:l(()=>[a(Ie,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=o=>y.value=o),density:"comfortable",variant:"outlined",class:"mr-2 md3-btn-toggle"},{default:l(()=>[a(S,{value:"4:3",disabled:u.value,class:"ratio-btn"},{default:l(()=>e[18]||(e[18]=[d("4:3")])),_:1},8,["disabled"]),a(S,{value:"16:9",disabled:u.value,class:"ratio-btn"},{default:l(()=>e[19]||(e[19]=[d("16:9")])),_:1},8,["disabled"]),a(S,{value:"auto",disabled:u.value,class:"ratio-btn"},{default:l(()=>e[20]||(e[20]=[d("自动")])),_:1},8,["disabled"])]),_:1},8,["modelValue"]),a($),A("div",Xe,[a(Ae,{modelValue:n.value,"onUpdate:modelValue":e[4]||(e[4]=o=>n.value=o),label:"自动连接",disabled:u.value,"hide-details":"",density:"comfortable",color:"primary",class:"mr-2 md3-switch"},null,8,["modelValue","disabled"])])]),_:1})]),_:1})]),_:1},512)]),_:1}),a(Q),a(Y,null,{default:l(()=>[a(S,{"prepend-icon":"mdi-content-save-outline",variant:"text",disabled:u.value||!h.value,onClick:he,size:"small",class:"md3-btn save-btn"},{default:l(()=>e[21]||(e[21]=[d(" 保存预设 ")])),_:1},8,["disabled"]),a($),a(S,{variant:"outlined",disabled:u.value,onClick:Se,size:"small",class:"md3-btn reset-btn"},{default:l(()=>e[22]||(e[22]=[d(" 重置 ")])),_:1},8,["disabled"]),a(S,{loading:u.value,disabled:!me.value,color:"primary",variant:"elevated",onClick:ae,size:"small",class:"md3-btn apply-btn"},{default:l(()=>e[23]||(e[23]=[d(" 应用 ")])),_:1},8,["loading","disabled"])]),_:1})])):I("",!0)]),_:1}),!U.value&&!k.alwaysShowControls?(z(),E(Q,{key:0})):I("",!0),k.alwaysShowControls?I("",!0):(z(),E(Y,{key:1,class:"control-actions"},{default:l(()=>[a(J,{location:"top",text:"视频控制"},{activator:l(({props:o})=>[a(S,O(o,{icon:m.value?"mdi-pause":"mdi-play",disabled:i.value!=="connected",onClick:Ce,variant:"text",size:"small",class:"control-btn play-btn"}),null,16,["icon","disabled"])]),_:1}),a(J,{location:"top",text:"重新连接"},{activator:l(({props:o})=>[a(S,O(o,{icon:"mdi-refresh",loading:i.value==="initializing",disabled:u.value,onClick:le,variant:"text",size:"small",class:"control-btn refresh-btn"}),null,16,["loading","disabled"])]),_:1}),a($),A("span",Ye,F(C.value?"视频流已连接":te.value),1),a($),a(J,{location:"top",text:"全屏"},{activator:l(({props:o})=>[a(S,O(o,{icon:w.value?"mdi-fullscreen-exit":"mdi-fullscreen",disabled:!C.value,onClick:ne,variant:"text",size:"small",class:"control-btn fullscreen-btn"}),null,16,["icon","disabled"])]),_:1}),a(J,{location:"top",text:U.value?"隐藏设置":"显示设置"},{activator:l(({props:o})=>[a(S,O(o,{icon:U.value?"mdi-chevron-up":"mdi-chevron-down",onClick:e[5]||(e[5]=et=>U.value=!U.value),variant:"text",size:"small",class:"control-btn expand-btn"}),null,16,["icon"])]),_:1},8,["text"])]),_:1})),a(Me,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=o=>R.value=o),"max-width":"400px",transition:"dialog-transition"},{default:l(()=>[a(re,{class:"dialog-card"},{default:l(()=>[a(oe,{class:"dialog-title"},{default:l(()=>e[24]||(e[24]=[d("保存预设")])),_:1}),a(ie,null,{default:l(()=>[a(X,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=o=>T.value=o),label:"预设名称",variant:"outlined",density:"comfortable",autofocus:"",rules:[o=>!!o||"预设名称不能为空"],class:"md3-field dialog-field"},null,8,["modelValue","rules"])]),_:1}),a(Y,{class:"dialog-actions"},{default:l(()=>[a($),a(S,{color:"primary",variant:"text",onClick:e[7]||(e[7]=o=>R.value=!1),class:"md3-btn cancel-btn"},{default:l(()=>e[25]||(e[25]=[d(" 取消 ")])),_:1}),a(S,{color:"primary",variant:"elevated",disabled:!T.value,onClick:ke,class:"md3-btn confirm-btn"},{default:l(()=>e[26]||(e[26]=[d(" 保存 ")])),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(Pe,{modelValue:V.value.show,"onUpdate:modelValue":e[10]||(e[10]=o=>V.value.show=o),color:V.value.color,timeout:V.value.timeout,class:"md3-snackbar"},{actions:l(()=>[a(S,{color:"white",variant:"text",onClick:e[9]||(e[9]=o=>V.value.show=!1),class:"snackbar-btn"},{default:l(()=>e[27]||(e[27]=[d(" 关闭 ")])),_:1})]),default:l(()=>[d(F(V.value.text)+" ",1)]),_:1},8,["modelValue","color","timeout"])]),_:1},8,["elevation","variant","class"])}}},lt=ce(Ze,[["__scopeId","data-v-167dcb22"]]);export{lt as R};
